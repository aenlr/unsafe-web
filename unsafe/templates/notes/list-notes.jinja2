{% extends "layout.jinja2" %}
{% set title = 'Anteckningar' -%}

{% block content %}
  <main class="container">
    <form method="get" action="{{ request.current_route_url() }}">

      <input name="embedded" type="hidden" value="{{ request.embedded }}">

      <nav class="level">
        <!-- Left side -->
        <div class="level-left">
          <div class="level-item">
            <div class="field has-addons">
              <p class="control">
                <a class="button is-static">
                  Från datum:
                </a>
              </p>
              <p class="control">
                <input class="input" name="from" type="date" value="{{ from }}">
              </p>
            </div>
          </div>
          <div class="level-item">
            <div class="field has-addons">
              <p class="control">
                <a class="button is-static">
                  Till:
                </a>
              </p>
              <p class="control">
                <input class="input" name="to" type="date" value="{{ to }}">
              </p>
            </div>
          </div>

          <div class="level-item">
            <div class="field">
              <p class="control">
                <input class="input" name="search" type="text" placeholder="Sök anteckning" value="{{ search }}"
                       autofocus onfocus="this.select()">
              </p>
            </div>
          </div>

          <div class="level-item">
            <p class="control">
              <button class="button" type="submit">
                Sök
              </button>
            </p>
          </div>
        </div>
      </nav>
    </form>
    <table class="table is-fullwidth is-hoverable">
      <thead>
      <tr>
        <th style="width: 10%">#</th>
        <th style="width: 60%">Innehåll</th>
        <th style="width: 20%">Tidpunkt</th>
        <th style="width: 10%">
          <a class="button is-primary" href="{{ 'new-note' | route_url }}">
            <span>Ny</span>
            <span class="icon">
                  <i class="fas fa-plus"></i>
                </span>
          </a>

        </th>
      </tr>
      </thead>
      <tbody>
      {% for note in notes %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ note.content | abbrev }}</td>
          <td>{{ note.created_at }}</td>
          <td>
            <a class="button is-small"
               href="{{ 'note' | route_url(note=note.note_id) }}">
              <span class="icon is-small">
                <i class="fas fa-edit"></i>
              </span>
            </a>

            <a class="button is-small is-danger"
               onclick="deleteNote(event)"
               href="{{ 'note-action' | route_url(_query={'action': 'delete', 'id': note.note_id}) }}">
              <span class=" icon is-small">
                <i class="fas fa-trash-alt"></i>
              </span>
            </a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
      <tfoot>
      <tr>
        <td colspan="4">
          <p class="subtitle is-5">
            {% if notes %}
              <strong>{{ notes | count }}</strong>
            {%- else -%}
              Inga
            {% endif %}
            anteckningar
          </p>
        </td>
      </tr>
      </tfoot>
    </table>
  </main>
{% endblock %}

{% block scripts %}
  <script defer src="{{ 'unsafe:static/js/modal.js' | static_url }}"></script>

  <script>
    function deleteNote(event) {
      event.preventDefault();

      const deleteSideEffectUrl = event.currentTarget.href;

      const performDelete = () => {
        fetch(deleteSideEffectUrl, {credentials: 'include'})
          .then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              alert('Kunde inte ta bort');
            }
          })
      };

      const modal = new Modal({
        title: 'Bekräfta',
        message: 'Vill du ta bort anteckningen?',
        buttons: [
          { role: 'delete', title: 'Ja, ta bort den', class: 'is-danger' },
          { role: 'cancel', title: 'Nej, behåll den' }
        ]
      });

      modal
        .on('delete', performDelete)
        .always(() => modal.destroy())
        .show();

    }
  </script>
{% endblock %}
